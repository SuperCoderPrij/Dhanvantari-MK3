export const askAboutMedicine = action({
  args: {
    medicineName: v.string(),
    manufacturer: v.string(),
    details: v.optional(v.string()),
  },
  // ...

await recordScan({
  medicineId: medicine._id,
  scanResult: "genuine",
  location: "Web Scan",
  deviceInfo: navigator.userAgent,
});

const prompt = `
  I have scanned a medicine with the following details:
  Name: ${args.medicineName}
  Manufacturer: ${args.manufacturer}
  Additional Details: ${args.details || "None"}

  Please provide a brief safety analysis and verification summary. 
  Is this a known manufacturer? What should I check on the packaging to ensure authenticity?
  Keep the response concise (under 150 words) and helpful for a consumer.
`;

const response = await askGemini({
  medicineName: scanResult.medicine.medicineName,
  manufacturer: scanResult.medicine.manufacturerName,
  details: `Batch: ${scanResult.medicine.batchNumber}, Expiry: ${scanResult.medicine.expiryDate}`
});

const scanId = await ctx.db.insert("medicineScans", {
  userId,
  medicineId: args.medicineId,
  scanResult: {
        isVerified: args.scanResult === "genuine",
        confidence: 1,
        medicineName: "Unknown", 
      },
  scanDate: Date.now(),
  location: args.location,
  deviceInfo: args.deviceInfo,
  imageStorageId: args.imageStorageId || ("" as any), // Handle optional storage
});

// Scan history - tracks all QR code scans
medicineScans: defineTable({
  medicineId: v.optional(v.id("medicines")),
  unitId: v.optional(v.id("medicine_units")), // Link to specific unit
  userId: v.optional(v.id("users")),
  imageStorageId: v.id("_storage"),
  scanResult: v.object({
    medicineName: v.optional(v.string()),
    confidence: v.number(),
    detectedText: v.optional(v.string()),
    isVerified: v.boolean(),
    matchedMedicineId: v.optional(v.id("medicines")),
  }),
  // ...
})